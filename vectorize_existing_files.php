<?php
require_once 'vendor/autoload.php';
require_once 'config/database.php';

use ResearcherAI\Logger;
use ResearcherAI\AIProviderFactory;
use ResearcherAI\YandexDiskClient;
use ResearcherAI\VectorPriceAnalyzer;
use ResearcherAI\CacheManager;

echo "ğŸš€ Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ²ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²...\n\n";

try {
    // Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸
    $stmt = $pdo->prepare("SELECT * FROM researcher_settings WHERE id = 1");
    $stmt->execute();
    $settings = $stmt->fetch(PDO::FETCH_ASSOC);
    
    if (!$settings) {
        throw new Exception('ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹');
    }
    
    // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€Ñ‹
    $aiApiKey = ($settings['ai_provider'] === 'openai' ? $settings['openai_key'] : $settings['deepseek_key']);
    $proxyUrl = !empty($settings['proxy_enabled']) && !empty($settings['proxy_url']) ? $settings['proxy_url'] : null;
    $aiProvider = AIProviderFactory::create($settings['ai_provider'], $aiApiKey, $proxyUrl);
    $yandexDiskClient = new YandexDiskClient($settings['yandex_token']);
    $dbBaseDir = __DIR__ . '/db';
    $cacheManager = new CacheManager($dbBaseDir);
    
    echo "âœ… ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹\n";
    
    // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ VectorPriceAnalyzer
    $vectorAnalyzer = new VectorPriceAnalyzer($aiProvider, $yandexDiskClient, $cacheManager);
    echo "âœ… VectorPriceAnalyzer Ğ³Ğ¾Ñ‚Ğ¾Ğ²\n\n";
    
    // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑĞ¿Ğ¸ÑĞ¾Ğº Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² Ñ Ğ¯Ğ½Ğ´ĞµĞºÑ.Ğ”Ğ¸ÑĞºĞ° Ğ¸Ğ· Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞº
    $folderPath = $settings['yandex_folder'] ?? '/2 ĞĞšĞ¢Ğ£ĞĞ›Ğ¬ĞĞ«Ğ• ĞŸĞ ĞĞ™Ğ¡Ğ«';
    echo "ğŸ“ ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑĞ¿Ğ¸ÑĞ¾Ğº Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² Ğ¸Ğ· Ğ¿Ğ°Ğ¿ĞºĞ¸ (Ğ¸Ğ· Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞº): {$folderPath}\n";
    
    $files = $yandexDiskClient->searchFilesByExtension($folderPath, '.xlsx');
    
    if (empty($files)) {
        echo "âš ï¸ Excel Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹, Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ´Ñ€ÑƒĞ³Ğ¸Ğµ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ñ‹...\n";
        
        // ĞŸÑ€Ğ¾Ğ±ÑƒĞµĞ¼ Ñ€Ğ°Ğ·Ğ½Ñ‹Ğµ Ñ€Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ¸Ñ
        $extensions = array('.xls', '.csv', '.txt');
        foreach ($extensions as $ext) {
            $files = $yandexDiskClient->searchFilesByExtension($folderPath, $ext);
            if (!empty($files)) {
                echo "âœ… ĞĞ°Ğ¹Ğ´ĞµĞ½Ñ‹ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ñ Ñ€Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ¸ĞµĞ¼ {$ext}: " . count($files) . "\n";
                break;
            }
        }
    }
    
    if (empty($files)) {
        // ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ Ğ¿Ğ°Ğ¿ĞºĞ¸ Ğ´Ğ»Ñ Ğ´Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ¸
        echo "ğŸ” Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ Ğ¿Ğ°Ğ¿ĞºĞ¸ {$folderPath}:\n";
        $allFiles = $yandexDiskClient->listFiles($folderPath);
        if (!empty($allFiles)) {
            foreach ($allFiles as $file) {
                $fileType = isset($file['type']) ? $file['type'] : 'file';
                echo "   " . ($fileType === 'dir' ? 'ğŸ“' : 'ğŸ“„') . " " . $file['name'] . "\n";
            }
        } else {
            echo "   ĞŸĞ°Ğ¿ĞºĞ° Ğ¿ÑƒÑÑ‚Ğ° Ğ¸Ğ»Ğ¸ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ°\n";
        }
        exit(1);
    }
    
    echo "ğŸ“Š ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ¾ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² Ğ´Ğ»Ñ Ğ²ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸: " . count($files) . "\n\n";
    
    $processed = 0;
    $errors = 0;
    
    foreach ($files as $file) {
        echo "ğŸ”„ ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼: " . $file['name'] . "\n";
        
        try {
            // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, ĞµÑÑ‚ÑŒ Ğ»Ğ¸ ÑƒĞ¶Ğµ ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚ Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ„Ğ°Ğ¹Ğ»Ğ°
            $cacheKey = md5($file['path']);
            $cachedText = $cacheManager->getCachedText($cacheKey);
            
            if ($cachedText) {
                echo "   ğŸ“‹ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚\n";
                $content = $cachedText;
            } else {
                echo "   ğŸ“¥ Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ñ„Ğ°Ğ¹Ğ» Ñ Ğ¯Ğ½Ğ´ĞµĞºÑ.Ğ”Ğ¸ÑĞºĞ°...\n";
                
                // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ download URL Ñ‡ĞµÑ€ĞµĞ· API
                $downloadUrl = $yandexDiskClient->getDownloadUrl($file['path']);
                if (!$downloadUrl) {
                    echo "   âŒ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑÑÑ‹Ğ»ĞºÑƒ Ğ´Ğ»Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸\n";
                    continue;
                }
                
                // Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ñ„Ğ°Ğ¹Ğ» Ñ Ğ¯Ğ½Ğ´ĞµĞºÑ.Ğ”Ğ¸ÑĞºĞ°
                $tempFilePath = sys_get_temp_dir() . '/' . basename($file['name']);
                $downloadSuccess = $yandexDiskClient->downloadFile($downloadUrl, $tempFilePath);
                
                if (!$downloadSuccess) {
                    echo "   âŒ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ñ„Ğ°Ğ¹Ğ»\n";
                    continue;
                }
                
                echo "   ğŸ“Š Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ Ñ‚ĞµĞºÑÑ‚ Ğ¸Ğ· Excel Ñ„Ğ°Ğ¹Ğ»Ğ°...\n";
                $content = $vectorAnalyzer->extractTextFromFile($tempFilePath);
                
                // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğ¹ Ñ„Ğ°Ğ¹Ğ»
                if (file_exists($tempFilePath)) {
                    unlink($tempFilePath);
                }
                
                if (empty($content)) {
                    echo "   âŒ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ÑŒ Ñ‚ĞµĞºÑÑ‚ Ğ¸Ğ· Ñ„Ğ°Ğ¹Ğ»Ğ°\n";
                    continue;
                }
                
                echo "   ğŸ’¾ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ñ‚ĞµĞºÑÑ‚ Ğ² ĞºÑÑˆ...\n";
                $cacheManager->setCache($file['path'], $file['modified'] ?? '', '', $content);
            }
            
            // Ğ Ğ°Ğ·Ğ±Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ½Ğ° Ñ‡Ğ°Ğ½ĞºĞ¸
            $chunks = explode("\n\n", $content);
            $chunks = array_filter($chunks, function($chunk) {
                return strlen(trim($chunk)) > 50;
            });
            
            if (empty($chunks)) {
                $chunks = explode("\n", $content);
                $chunks = array_filter($chunks, function($chunk) {
                    return strlen(trim($chunk)) > 30;
                });
            }
            
            if (empty($chunks)) {
                echo "   âš ï¸ ĞĞµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´ÑÑ‰Ğ¸Ñ… Ñ‡Ğ°Ğ½ĞºĞ¾Ğ²\n";
                continue;
            }
            
            // ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ñ‡Ğ°Ğ½ĞºĞ¾Ğ² Ğ´Ğ»Ñ Ñ‚ĞµÑÑ‚Ğ°
            $chunks = array_slice($chunks, 0, 5);
            
            // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ²ĞµĞºÑ‚Ğ¾Ñ€Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
            $result = $vectorAnalyzer->vectorCacheManager->storeVectorData($file['path'], $chunks);
            
            if ($result) {
                echo "   âœ… Ğ’ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾ Ñ‡Ğ°Ğ½ĞºĞ¾Ğ²: " . count($chunks) . "\n";
                $processed++;
            } else {
                echo "   âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğ¸ Ğ²ĞµĞºÑ‚Ğ¾Ñ€Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…\n";
                $errors++;
            }
            
            sleep(1);
            
        } catch (Exception $e) {
            echo "   âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: " . $e->getMessage() . "\n";
            $errors++;
        }
    }
    
    echo "\nğŸ¯ Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ²ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸:\n";
    echo "   - ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ¾ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²: {$processed}\n";
    echo "   - ĞÑˆĞ¸Ğ±Ğ¾Ğº: {$errors}\n";
    
    $stats = $vectorAnalyzer->getVectorSearchStats();
    echo "\nğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°:\n";
    echo "   - Ğ’ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²: " . $stats['vectorized_files_count'] . "\n";
    
} catch (Exception $e) {
    echo "âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: " . $e->getMessage() . "\n";
}
