<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç —Å—Ç–∞—Ç—É—Å–æ–≤ UI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .status-icon.status-success {
            color: #28a745 !important;
        }

        .status-icon.status-warning {
            color: #ffc107 !important;
        }

        .status-icon.status-error {
            color: #dc3545 !important;
        }

        .status-item {
            transition: all 0.3s ease;
            margin-bottom: 1rem;
            padding: 1rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .test-section {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .btn-test {
            margin: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-12">
                <div class="test-section">
                    <h1 class="text-center mb-4">üß™ –¢–µ—Å—Ç —Å—Ç–∞—Ç—É—Å–æ–≤ UI</h1>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="test-section">
                                <h5>üì° –°—Ç–∞—Ç—É—Å—ã API</h5>
                                
                                <div id="openai-status" class="status-item">
                                    <i class="fas fa-circle status-icon"></i>
                                    <span class="ms-2 fw-bold">OpenAI:</span>
                                    <span class="status-text ms-1">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
                                </div>
                                
                                <div id="deepseek-status" class="status-item">
                                    <i class="fas fa-circle status-icon"></i>
                                    <span class="ms-2 fw-bold">DeepSeek:</span>
                                    <span class="status-text ms-1">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
                                </div>
                                
                                <div id="yandex-status" class="status-item">
                                    <i class="fas fa-circle status-icon"></i>
                                    <span class="ms-2 fw-bold">–Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫:</span>
                                    <span class="status-text ms-1">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-8">
                            <div class="test-section">
                                <h5>üéÆ –¢–µ—Å—Ç–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h5>
                                
                                <div class="mb-3">
                                    <button class="btn btn-primary btn-test" onclick="checkApiStatus()">
                                        <i class="fas fa-sync"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã API
                                    </button>
                                    
                                    <button class="btn btn-success btn-test" onclick="testSuccessStatus()">
                                        <i class="fas fa-check"></i> –¢–µ—Å—Ç Success
                                    </button>
                                    
                                    <button class="btn btn-warning btn-test" onclick="testWarningStatus()">
                                        <i class="fas fa-exclamation"></i> –¢–µ—Å—Ç Warning
                                    </button>
                                    
                                    <button class="btn btn-danger btn-test" onclick="testErrorStatus()">
                                        <i class="fas fa-times"></i> –¢–µ—Å—Ç Error
                                    </button>
                                </div>
                                
                                <div class="mb-3">
                                    <input type="text" class="form-control" id="test-query" 
                                           placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å..." 
                                           value="–Ω–∞–π–¥–∏ —Ü–µ–Ω—ã –Ω–∞ –ª–∞–º–∏–Ω–∞—Ç">
                                    <button class="btn btn-info btn-test mt-2" onclick="testQuery()">
                                        <i class="fas fa-search"></i> –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
                                    </button>
                                </div>
                                
                                <div id="test-log" class="mt-3">
                                    <h6>üìã –õ–æ–≥ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</h6>
                                    <div id="log-content" class="border p-2 bg-light" style="height: 200px; overflow-y: auto;">
                                        <small class="text-muted">–ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é...</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        function log(message) {
            const logContent = document.getElementById('log-content');
            const time = new Date().toLocaleTimeString();
            logContent.innerHTML += `<div><small class="text-muted">[${time}]</small> ${message}</div>`;
            logContent.scrollTop = logContent.scrollHeight;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        function updateStatusIndicator(id, status) {
            const indicator = document.getElementById(id);
            if (!indicator) {
                log(`‚ùå –≠–ª–µ–º–µ–Ω—Ç ${id} –Ω–µ –Ω–∞–π–¥–µ–Ω`);
                return;
            }

            const statusIcon = indicator.querySelector('.status-icon');
            const statusText = indicator.querySelector('.status-text');

            if (!statusIcon || !statusText) {
                log(`‚ùå –≠–ª–µ–º–µ–Ω—Ç—ã .status-icon –∏–ª–∏ .status-text –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ ${id}`);
                return;
            }

            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∫–ª–∞—Å—Å—ã
            statusIcon.classList.remove('status-success', 'status-warning', 'status-error');

            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –∫–ª–∞—Å—Å—ã –∏ —Ç–µ–∫—Å—Ç
            switch (status.status) {
                case 'success':
                    statusIcon.classList.add('status-success');
                    statusText.textContent = status.message || '–†–∞–±–æ—Ç–∞–µ—Ç';
                    log(`‚úÖ ${id}: ${status.message || '–†–∞–±–æ—Ç–∞–µ—Ç'}`);
                    break;
                case 'warning':
                    statusIcon.classList.add('status-warning');
                    statusText.textContent = status.message || '–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ';
                    log(`‚ö†Ô∏è ${id}: ${status.message || '–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ'}`);
                    break;
                case 'error':
                default:
                    statusIcon.classList.add('status-error');
                    statusText.textContent = status.message || '–û—à–∏–±–∫–∞';
                    log(`‚ùå ${id}: ${status.message || '–û—à–∏–±–∫–∞'}`);
                    break;
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ API
        async function checkApiStatus() {
            log('üîÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ API...');
            
            try {
                const response = await fetch('/issledovatel/api/check_status.php');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const status = await response.json();
                log('üì° –û—Ç–≤–µ—Ç API –ø–æ–ª—É—á–µ–Ω');

                // –ú–∞–ø–ø–∏–Ω–≥ —Ü–≤–µ—Ç–æ–≤ –∫ —Å—Ç–∞—Ç—É—Å–∞–º
                const mapColorToStatus = (color, errorMsg) => {
                    switch (color) {
                        case 'green': return { status: 'success', message: errorMsg };
                        case 'yellow': return { status: 'warning', message: errorMsg };
                        case 'red': return { status: 'error', message: errorMsg };
                        default: return { status: 'error', message: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å' };
                    }
                };

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å—ã
                updateStatusIndicator('openai-status', mapColorToStatus(
                    status.openai, 
                    status.error_messages?.openai || '–ù–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω'
                ));
                
                updateStatusIndicator('deepseek-status', mapColorToStatus(
                    status.deepseek, 
                    status.error_messages?.deepseek || '–ù–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω'
                ));
                
                updateStatusIndicator('yandex-status', mapColorToStatus(
                    status.yandex, 
                    status.error_messages?.yandex || '–ù–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω'
                ));

                log('‚úÖ –í—Å–µ —Å—Ç–∞—Ç—É—Å—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã');

            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞: ${error.message}`);
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å—ã –æ—à–∏–±–∫–∏
                updateStatusIndicator('openai-status', { status: 'error', message: '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è' });
                updateStatusIndicator('deepseek-status', { status: 'error', message: '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è' });
                updateStatusIndicator('yandex-status', { status: 'error', message: '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è' });
            }
        }

        // –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ç–∞—Ç—É—Å—ã
        function testSuccessStatus() {
            log('üß™ –¢–µ—Å—Ç —Å—Ç–∞—Ç—É—Å–∞ Success');
            updateStatusIndicator('openai-status', { status: 'success', message: '–¢–µ—Å—Ç: –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!' });
            updateStatusIndicator('deepseek-status', { status: 'success', message: '–¢–µ—Å—Ç: —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ OK' });
            updateStatusIndicator('yandex-status', { status: 'success', message: '–¢–µ—Å—Ç: –¥–∏—Å–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω' });
        }

        function testWarningStatus() {
            log('üß™ –¢–µ—Å—Ç —Å—Ç–∞—Ç—É—Å–∞ Warning');
            updateStatusIndicator('openai-status', { status: 'warning', message: '–¢–µ—Å—Ç: –º–∞–ª–æ —Å—Ä–µ–¥—Å—Ç–≤' });
            updateStatusIndicator('deepseek-status', { status: 'warning', message: '–¢–µ—Å—Ç: –º–µ–¥–ª–µ–Ω–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç' });
            updateStatusIndicator('yandex-status', { status: 'warning', message: '–¢–µ—Å—Ç: –º–µ—Å—Ç–æ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è' });
        }

        function testErrorStatus() {
            log('üß™ –¢–µ—Å—Ç —Å—Ç–∞—Ç—É—Å–∞ Error');
            updateStatusIndicator('openai-status', { status: 'error', message: '–¢–µ—Å—Ç: –Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è' });
            updateStatusIndicator('deepseek-status', { status: 'error', message: '–¢–µ—Å—Ç: API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ' });
            updateStatusIndicator('yandex-status', { status: 'error', message: '–¢–µ—Å—Ç: –æ—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏' });
        }

        // –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
        async function testQuery() {
            const query = document.getElementById('test-query').value.trim();
            if (!query) {
                log('‚ùå –í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
                return;
            }

            log(`üîç –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞: "${query}"`);
            
            try {
                const response = await fetch('/issledovatel/api/process_query.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query: query })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();
                
                if (result.success) {
                    log('‚úÖ –ó–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ');
                    if (result.progress) {
                        log(`üìä –ü–æ–ª—É—á–µ–Ω–æ —à–∞–≥–æ–≤ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞: ${result.progress.length}`);
                        result.progress.forEach((step, i) => {
                            log(`üìç –®–∞–≥ ${i + 1}: ${step}`);
                        });
                    }
                    if (result.answer) {
                        log(`üí¨ –û—Ç–≤–µ—Ç: ${result.answer.substring(0, 100)}...`);
                    }
                } else {
                    log(`‚ùå –û—à–∏–±–∫–∞ –≤ –∑–∞–ø—Ä–æ—Å–µ: ${result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
                }

            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ${error.message}`);
            }
        }

        // –ê–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –∞–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤...');
            checkApiStatus();
        });
    </script>
</body>
</html>
