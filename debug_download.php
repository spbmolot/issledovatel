<?php

require_once 'vendor/autoload.php';

use ResearcherAI\YandexDiskClient;
use ResearcherAI\Logger;

echo "๐ ะะธะฐะณะฝะพััะธะบะฐ ะทะฐะณััะทะบะธ ัะฐะนะปะพะฒ ั ะฏะฝะดะตะบั.ะะธัะบะฐ...\n\n";

try {
    // ะะะกะขะะ ะะะะะะะซะ ะะะกะขะะะะะ ะดะปั ะดะธะฐะณะฝะพััะธะบะธ
    // TODO: ะะพัะปะต ะดะธะฐะณะฝะพััะธะบะธ ัะฝะธัะธัะธัะพะฒะฐัั ะฑะฐะทั ะดะฐะฝะฝัั
    echo "โ๏ธ ะัะฟะพะปัะทััััั ัะตััะพะฒัะต ะฝะฐัััะพะนะบะธ ะดะปั ะดะธะฐะณะฝะพััะธะบะธ\n";
    echo "   ะะฒะตะดะธัะต ัะตะฐะปัะฝัะน ัะพะบะตะฝ ะฏะฝะดะตะบั.ะะธัะบะฐ ะดะปั ัะตััะธัะพะฒะฐะฝะธั\n\n";
    
    // ะะฐะผะตะฝะธัะต ะฝะฐ ัะตะฐะปัะฝัะต ะทะฝะฐัะตะฝะธั:
    $token = "ะะกะขะะะฌะขะ_ะกะฎะะ_ะะะะะฌะะซะ_ะขะะะะ_ะฏะะะะะก_ะะะกะะ"; 
    $folderPath = "/2 ะะะขะฃะะะฌะะซะ ะะะะะกะซ";
    
    echo "๐ ะะฐัััะพะนะบะธ:\n";
    echo "   - ะขะพะบะตะฝ: " . (empty($token) || $token === "ะะกะขะะะฌะขะ_ะกะฎะะ_ะะะะะฌะะซะ_ะขะะะะ_ะฏะะะะะก_ะะะกะะ" ? "ะะ ะะะกะขะะะะ" : "ะะกะขะฌ (" . strlen($token) . " ัะธะผะฒะพะปะพะฒ)") . "\n";
    echo "   - ะะฐะฟะบะฐ: {$folderPath}\n\n";
    
    if (empty($token) || $token === "ะะกะขะะะฌะขะ_ะกะฎะะ_ะะะะะฌะะซะ_ะขะะะะ_ะฏะะะะะก_ะะะกะะ") {
        die("โ ะฃััะฐะฝะพะฒะธัะต ัะตะฐะปัะฝัะน ัะพะบะตะฝ ะฏะฝะดะตะบั.ะะธัะบะฐ ะฒ ัะบัะธะฟัะต!\n");
    }
    
    // ะกะพะทะดะฐะตะผ ะบะปะธะตะฝั
    $yandexDiskClient = new YandexDiskClient($token);
    
    // ะัะพะฒะตััะตะผ ัะพะตะดะธะฝะตะฝะธะต
    echo "๐ ะัะพะฒะตััะตะผ ัะพะตะดะธะฝะตะฝะธะต ั ะฏะฝะดะตะบั.ะะธัะบะพะผ...\n";
    if (!$yandexDiskClient->testConnection()) {
        die("โ ะะต ัะดะฐะปะพัั ะฟะพะดะบะปััะธัััั ะบ ะฏะฝะดะตะบั.ะะธัะบั!\n");
    }
    echo "โ ะกะพะตะดะธะฝะตะฝะธะต ัััะฐะฝะพะฒะปะตะฝะพ\n\n";
    
    // ะัะตะผ ัะฐะนะปั
    echo "๐ ะัะตะผ Excel ัะฐะนะปั ะฒ ะฟะฐะฟะบะต: {$folderPath}\n";
    $files = $yandexDiskClient->searchFilesByExtension($folderPath, '.xlsx');
    echo "๐ ะะฐะนะดะตะฝะพ ัะฐะนะปะพะฒ: " . count($files) . "\n\n";
    
    if (empty($files)) {
        die("โ ะคะฐะนะปั ะฝะต ะฝะฐะนะดะตะฝั!\n");
    }
    
    // ะขะตััะธััะตะผ ะฟะตัะฒัะน ัะฐะนะป
    $testFile = $files[0];
    echo "๐งช ะขะตััะธััะตะผ ัะฐะนะป: {$testFile['name']}\n";
    echo "   - ะััั: {$testFile['path']}\n";
    echo "   - ะะฐะทะผะตั: " . (isset($testFile['size']) ? $testFile['size'] : 'ะฝะตะธะทะฒะตััะฝะพ') . "\n\n";
    
    // ะะพะปััะฐะตะผ download URL
    echo "๐ ะะพะปััะฐะตะผ download URL...\n";
    $downloadUrl = $yandexDiskClient->getDownloadUrl($testFile['path']);
    
    if (!$downloadUrl) {
        echo "โ ะะต ัะดะฐะปะพัั ะฟะพะปััะธัั download URL\n";
        echo "   ะัะพะฒะตัััะต ะปะพะณะธ ะดะปั ะฟะพะดัะพะฑะฝะพััะตะน\n";
        die();
    }
    
    echo "โ Download URL ะฟะพะปััะตะฝ\n";
    echo "   URL: " . substr($downloadUrl, 0, 80) . "...\n\n";
    
    // ะัะพะฑัะตะผ ะทะฐะณััะทะธัั ัะฐะนะป
    echo "๐ฅ ะัะพะฑัะตะผ ะทะฐะณััะทะธัั ัะฐะนะป...\n";
    $tempFilePath = sys_get_temp_dir() . '/' . basename($testFile['name']);
    echo "   ะัะตะผะตะฝะฝัะน ัะฐะนะป: {$tempFilePath}\n";
    
    $success = $yandexDiskClient->downloadFile($downloadUrl, $tempFilePath);
    
    if ($success && file_exists($tempFilePath)) {
        $fileSize = filesize($tempFilePath);
        echo "โ ะคะฐะนะป ััะฟะตัะฝะพ ะทะฐะณััะถะตะฝ!\n";
        echo "   ะะฐะทะผะตั: {$fileSize} ะฑะฐะนั\n";
        
        // ะฃะดะฐะปัะตะผ ัะตััะพะฒัะน ัะฐะนะป
        unlink($tempFilePath);
        echo "   ะัะตะผะตะฝะฝัะน ัะฐะนะป ัะดะฐะปะตะฝ\n";
    } else {
        echo "โ ะัะธะฑะบะฐ ะทะฐะณััะทะบะธ ัะฐะนะปะฐ\n";
        echo "   ะัะพะฒะตัััะต ะปะพะณะธ ะดะปั ะฟะพะดัะพะฑะฝะพััะตะน\n";
        
        if (file_exists($tempFilePath)) {
            echo "   ะคะฐะนะป ัะพะทะดะฐะฝ, ะฝะพ ะฒะพะทะผะพะถะฝะพ ะฟัััะพะน: " . filesize($tempFilePath) . " ะฑะฐะนั\n";
            unlink($tempFilePath);
        }
    }
    
} catch (Exception $e) {
    echo "โ ะะจะะะะ: " . $e->getMessage() . "\n";
    echo "   ะคะฐะนะป: " . $e->getFile() . "\n";
    echo "   ะกััะพะบะฐ: " . $e->getLine() . "\n";
}

echo "\n๐ ะะธะฐะณะฝะพััะธะบะฐ ะทะฐะฒะตััะตะฝะฐ!\n";
